# Infrastructure services for vision-factory e2e tests.
# Started by run.py via `docker compose --profile <p> up -d`.
#
# Camera device is configurable via VIDEO_DEVICE env var (default /dev/video0):
#   VIDEO_DEVICE=/dev/video2 python e2e/run.py --model yolo --backend cuda --usb-cam

services:
  camera:
    image: vision-factory-e2e-base:jazzy
    profiles: ["camera"]
    command: >
      bash -c "source /opt/venv/bin/activate &&
               source /opt/ros/jazzy/setup.bash &&
               ros2 run usb_cam usb_cam_node_exe --ros-args
               -p video_device:=${VIDEO_DEVICE:-/dev/video0}
               -r /image_raw:=/camera/image_raw"
    devices:
      - ${VIDEO_DEVICE:-/dev/video0}:${VIDEO_DEVICE:-/dev/video0}
    networks:
      - vision-e2e

  viz:
    image: vision-factory-e2e-base:jazzy
    profiles: ["viz"]
    volumes:
      - ./viz_node.py:/ros_ws/viz_node.py:ro
    command: >
      bash -c "source /opt/venv/bin/activate &&
               source /opt/ros/jazzy/setup.bash &&
               python3 /ros_ws/viz_node.py"
    networks:
      - vision-e2e

  rqt:
    image: vision-factory-e2e-base:jazzy
    profiles: ["rqt"]
    environment:
      - DISPLAY=${DISPLAY:-:0}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    command: >
      bash -c "source /opt/venv/bin/activate &&
               source /opt/ros/jazzy/setup.bash &&
               ros2 run rqt_image_view rqt_image_view /detections_viz"
    networks:
      - vision-e2e

networks:
  vision-e2e:
    name: vision-e2e
